<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Checkout - EventHub' %></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .payment-method:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .payment-method.active {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .payment-icon {
            font-size: 2rem;
            color: #6c757d;
        }
        .payment-method.active .payment-icon {
            color: #0d6efd;
        }
        .ticket-icon {
            width: 40px;
            height: 40px;
            background-color: #e7f1ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
        .secure-badge {
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
        }
        
        /* Stripe Elements Styles */
        .StripeElement {
            box-sizing: border-box;
            height: calc(3.5rem + 2px);
            padding: 1rem .75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background-color: white;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .StripeElement--focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: 0;
        }
        .StripeElement--invalid {
            border-color: #dc3545;
        }
        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="bi bi-calendar-event text-primary me-2"></i>
                EventHub
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row">
            <!-- Order Summary -->
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="fw-bold mb-3">
                            <i class="bi bi-receipt me-2"></i>Order Summary
                        </h5>
                    </div>
                    
                    <div class="card-body">
                        <!-- Event Details -->
                        <div class="d-flex mb-4">
                            <% if (event.imageUrl) { %>
                            <img src="<%= event.imageUrl %>" alt="<%= event.title %>" 
                                 class="rounded" style="width: 80px; height: 80px; object-fit: cover;">
                            <% } else { %>
                            <div class="ticket-icon">
                                <i class="bi bi-ticket text-primary"></i>
                            </div>
                            <% } %>
                            
                            <div class="ms-3">
                                <h6 class="fw-bold mb-1"><%= event.title %></h6>
                                <p class="text-muted small mb-1">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    <%= new Date(event.date).toLocaleDateString('en-US', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    }) %>
                                </p>
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-clock me-1"></i>
                                    <%= event.time %>
                                </p>
                            </div>
                        </div>

                        <!-- Order Breakdown - FIXED PRICE HANDLING -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Ticket Price</span>
                                <% 
                                // Convert price to number safely
                                const eventPrice = parseFloat(event.price) || 0;
                                const eventTaxRate = parseFloat(event.taxRate) || 0;
                                const eventServiceFee = parseFloat(event.serviceFee) || 0;
                                const ticketQuantity = parseInt(quantity) || 1;
                                const subtotal = eventPrice * ticketQuantity;
                                const taxAmount = subtotal * eventTaxRate;
                                const serviceFeeAmount = eventServiceFee * ticketQuantity;
                                const calculatedTotal = subtotal + taxAmount + serviceFeeAmount;
                                const totalAmountDisplay = calculatedTotal.toFixed(2);
                                %>
                                <span>$<%= eventPrice.toFixed(2) %></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Quantity</span>
                                <span><%= ticketQuantity %></span>
                            </div>
                            
                            <% if (eventTaxRate > 0) { %>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Tax (<%= (eventTaxRate * 100).toFixed(2) %>%)</span>
                                <span>$<%= taxAmount.toFixed(2) %></span>
                            </div>
                            <% } %>
                            
                            <% if (eventServiceFee > 0) { %>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Service Fee</span>
                                <span>$<%= serviceFeeAmount.toFixed(2) %></span>
                            </div>
                            <% } %>
                        </div>

                        <hr>

                        <!-- Total -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fw-bold">Total</span>
                            <span class="h4 fw-bold text-primary">$<%= totalAmountDisplay %></span>
                        </div>

                        <!-- Security Badge -->
                        <div class="text-center mt-4">
                            <span class="secure-badge">
                                <i class="bi bi-shield-check me-1"></i>
                                100% Secure Payment
                            </span>
                            <p class="text-muted small mt-2 mb-0">
                                Powered by Stripe - Your payment is encrypted
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-credit-card me-2"></i>Payment Details
                        </h5>
                    </div>
                    
                    <div class="card-body">
                        <!-- Error Display Area -->
                        <div id="error-alert-container"></div>

                        <!-- Payment Method Selection -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Select Payment Method</h6>
                            
                            <!-- Credit Card Option -->
                            <div class="payment-method active" id="stripe-method">
                                <div class="d-flex align-items-center">
                                    <div class="payment-icon me-3">
                                        <i class="bi bi-credit-card-2-front"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1">Credit / Debit Card</h6>
                                        <p class="text-muted small mb-0">
                                            Visa, Mastercard, American Express, Discover
                                        </p>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" 
                                               id="stripeRadio" value="stripe" checked>
                                    </div>
                                </div>
                            </div>

                            <!-- PayPal Option -->
                            <div class="payment-method" id="paypal-method">
                                <div class="d-flex align-items-center">
                                    <div class="payment-icon me-3">
                                        <i class="bi bi-paypal"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1">PayPal</h6>
                                        <p class="text-muted small mb-0">
                                            Pay with your PayPal account or credit card
                                        </p>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" 
                                               id="paypalRadio" value="paypal">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stripe Card Elements Form -->
                        <div id="stripe-payment-form">
                            <form id="payment-form">
                                <!-- Card details will be injected here by Stripe.js -->
                                <div class="mb-3">
                                    <label for="card-element" class="form-label">Card Details</label>
                                    <div id="card-element" class="StripeElement">
                                        <!-- Stripe will inject the Card Element here -->
                                    </div>
                                    <div id="card-errors" role="alert" class="text-danger small mt-2"></div>
                                </div>

                                <!-- Billing Information -->
                                <div class="mb-4">
                                    <h6 class="fw-bold mb-3">Billing Information</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Name on Card</label>
                                            <input type="text" class="form-control" id="cardholder-name" 
                                                   value="<%= user.firstName %> <%= user.lastName %>" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email for Receipt</label>
                                            <input type="email" class="form-control" id="cardholder-email" 
                                                   value="<%= user.email %>" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- Terms and Conditions -->
                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="termsCheck" required>
                                        <label class="form-check-label small" for="termsCheck">
                                            I agree to the 
                                            <a href="/terms" target="_blank" class="text-decoration-none">Terms of Service</a>
                                            and 
                                            <a href="/privacy" target="_blank" class="text-decoration-none">Privacy Policy</a>
                                        </label>
                                    </div>
                                </div>

                                <!-- Payment Button -->
                                <button type="submit" id="stripe-submit-button" class="btn btn-primary btn-lg w-100">
                                    <i class="bi bi-lock-fill me-2"></i>
                                    Pay $<%= totalAmountDisplay %> Securely
                                </button>
                            </form>
                        </div>

                        <!-- PayPal Section (Hidden by default) -->
                        <div id="paypal-payment-form" class="d-none">
                            <div class="text-center py-3">
                                <p class="text-muted mb-3">You'll be redirected to PayPal to complete your payment</p>
                                <div id="paypal-button-container"></div>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="text-center mt-4">
                            <p class="text-muted small">
                                <i class="bi bi-shield-check me-1"></i>
                                Your payment is secured with 256-bit SSL encryption
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3">Processing your payment...</h5>
            <p class="text-muted">Please do not close this window</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Stripe.js v3 -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Debug: Check what variables are available
        console.log('Template variables:', {
            eventId: '<%= event.eventId %>',
            eventTitle: '<%= event.title %>',
            eventPrice: <%= eventPrice %>,
            quantity: <%= ticketQuantity %>,
            totalAmount: <%= totalAmountDisplay %>,
            stripePublicKey: '<%= stripePublicKey ? "Set" : "NOT SET" %>',
            userEmail: '<%= user.email %>'
        });

        // Initialize Stripe
        <% if (stripePublicKey) { %>
        const stripe = Stripe('<%= stripePublicKey %>');
        const elements = stripe.elements();
        
        // Create a card element
        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#212529',
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    '::placeholder': {
                        color: '#6c757d'
                    }
                },
                invalid: {
                    color: '#dc3545'
                }
            }
        });
        
        // Mount the card element to the DOM
        cardElement.mount('#card-element');
        
        // Handle real-time validation errors from the card Element
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        <% } else { %>
        console.error('Stripe public key is not set!');
        <% } %>
        
        // Payment method selection
        const stripeMethod = document.getElementById('stripe-method');
        const paypalMethod = document.getElementById('paypal-method');
        const stripeForm = document.getElementById('stripe-payment-form');
        const paypalForm = document.getElementById('paypal-payment-form');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Toggle between payment methods
        stripeMethod.addEventListener('click', () => {
            stripeMethod.classList.add('active');
            paypalMethod.classList.remove('active');
            stripeForm.classList.remove('d-none');
            paypalForm.classList.add('d-none');
        });
        
        paypalMethod.addEventListener('click', () => {
            paypalMethod.classList.add('active');
            stripeMethod.classList.remove('active');
            paypalForm.classList.remove('d-none');
            stripeForm.classList.add('d-none');
        });
        
        // Handle Stripe form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (!validateForm()) return;
            
            const submitButton = document.getElementById('stripe-submit-button');
            loadingOverlay.style.display = 'flex';
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
            
            // Get billing details
            const cardholderName = document.getElementById('cardholder-name').value;
            const cardholderEmail = document.getElementById('cardholder-email').value;
            
            try {
                // Create payment method
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                        email: cardholderEmail,
                    },
                });
                
                if (error) {
                    showError(error.message);
                    resetButtonState();
                    return;
                }
                
                console.log('Sending payment to server...', {
                    eventId: '<%= event.eventId %>',
                    quantity: <%= ticketQuantity %>,
                    amount: <%= totalAmountDisplay %>
                });
                
                // Send paymentMethod.id to your server
                const response = await fetch('/payments/stripe/process-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventId: '<%= event.eventId %>',
                        quantity: <%= ticketQuantity %>,
                        paymentMethodId: paymentMethod.id,
                        amount: <%= totalAmountDisplay %>,
                        email: cardholderEmail,
                        name: cardholderName
                    })
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    if (data.requiresAction) {
                        // Handle 3D Secure authentication
                        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(
                            data.clientSecret
                        );
                        
                        if (confirmError) {
                            showError('Payment failed: ' + confirmError.message);
                            resetButtonState();
                        } else if (paymentIntent.status === 'succeeded') {
                            // Payment succeeded with 3D Secure
                            console.log('3D Secure payment succeeded, redirecting to:', data.redirectUrl);
                            window.location.href = data.redirectUrl || '/payments/success';
                        }
                    } else {
                        // Payment succeeded without 3D Secure
                        console.log('Payment succeeded, redirecting to:', data.redirectUrl);
                        window.location.href = data.redirectUrl || '/payments/success';
                    }
                } else {
                    showError(data.message || 'Payment failed');
                    resetButtonState();
                }
            } catch (error) {
                console.error('Payment error:', error);
                showError('Network error. Please try again.');
                resetButtonState();
            }
        });
        
        // Form validation
        function validateForm() {
            const termsCheck = document.getElementById('termsCheck');
            const cardholderName = document.getElementById('cardholder-name').value;
            const cardholderEmail = document.getElementById('cardholder-email').value;
            
            // Clear previous errors
            clearErrors();
            
            let isValid = true;
            
            if (!termsCheck.checked) {
                showError('Please accept the Terms and Conditions');
                termsCheck.focus();
                isValid = false;
            }
            
            if (!cardholderName.trim()) {
                showError('Please enter the name on card');
                document.getElementById('cardholder-name').focus();
                isValid = false;
            }
            
            if (!cardholderEmail.trim() || !isValidEmail(cardholderEmail)) {
                showError('Please enter a valid email address');
                document.getElementById('cardholder-email').focus();
                isValid = false;
            }
            
            return isValid;
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Utility functions
        function showError(message) {
            const errorContainer = document.getElementById('error-alert-container');
            
            // Create error alert
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger alert-dismissible fade show';
            errorAlert.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Clear previous errors and add new one
            errorContainer.innerHTML = '';
            errorContainer.appendChild(errorAlert);
            
            // Scroll to error
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (errorAlert.parentNode) {
                    errorAlert.classList.remove('show');
                    setTimeout(() => errorAlert.remove(), 150);
                }
            }, 10000);
        }
        
        function clearErrors() {
            document.getElementById('error-alert-container').innerHTML = '';
            document.getElementById('card-errors').textContent = '';
        }
        
        function resetButtonState() {
            loadingOverlay.style.display = 'none';
            const submitButton = document.getElementById('stripe-submit-button');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="bi bi-lock-fill me-2"></i>Pay $<%= totalAmountDisplay %> Securely';
            }
        }
        
        // Handle page refresh warning
        window.addEventListener('beforeunload', function (e) {
            if (loadingOverlay.style.display === 'flex') {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Check if Stripe is properly initialized
        document.addEventListener('DOMContentLoaded', function() {
            if (!'<%= stripePublicKey %>') {
                showError('Payment system is not configured. Please contact support.');
                const submitButton = document.getElementById('stripe-submit-button');
                if (submitButton) submitButton.disabled = true;
            }
            
            // Log for debugging
            console.log('Checkout page loaded successfully');
            console.log('Event ID:', '<%= event.eventId %>');
            console.log('Quantity:', <%= ticketQuantity %>);
            console.log('Total:', <%= totalAmountDisplay %>);
        });
    </script>
</body>
</html>